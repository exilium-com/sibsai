import{L as H,bf as q,aq as G,bg as K,bp as W,bj as J,b3 as Q,as as X,O as Y,b4 as Z,aD as ee,aw as O,bk as te,bl as ae,bo as se,ay as ne,aG as oe,aa as I,bq as ie,T as re,e as y,aP as ce,d as L,b as a,c as l,w as d,C as f,y as m,V as P,m as D,f as x,n as F,h as V,z as le,s as v,G as U,v as de,$,r as ue,S as N,a as me,k as he,ak as ye,F as w,H as z,br as pe,I as ge,D as fe,t as ke,a$ as ve,l as r,bs as _e,an as t,bt as be,W as Ie,a0 as Ce,j as Me}from"./main-B70GkIj-.js";import{R as we}from"./index-B9eHhWSs.js";import{V as E,R as xe}from"./rating-popup-BZQd9w9G.js";import{V as j}from"./VContainer-DYD4C6sI.js";import{V as Ve}from"./VTextField-CfpYqE7h.js";const Re=H({app:Boolean,color:String,height:{type:[Number,String],default:"auto"},...q(),...G(),...K(),...W(),...J(),...Q({tag:"footer"}),...X()},"VFooter"),Se=Y()({name:"VFooter",props:Re(),setup(n,_){let{slots:e}=_;const{themeClasses:u}=Z(n),{backgroundColorClasses:c,backgroundColorStyles:R}=ee(O(n,"color")),{borderClasses:S}=te(n),{elevationClasses:T}=ae(n),{roundedClasses:C}=se(n),k=ne(32),{resizeRef:M}=oe(p=>{p.length&&(k.value=p[0].target.clientHeight)}),b=I(()=>n.height==="auto"?k.value:parseInt(n.height,10)),{layoutItemStyles:o,layoutIsReady:i}=ie({id:n.name,order:I(()=>parseInt(n.order,10)),position:I(()=>"bottom"),layoutSize:b,elementSize:I(()=>n.height==="auto"?void 0:b.value),active:I(()=>n.app),absolute:O(n,"absolute")});return re(()=>y(n.tag,{ref:M,class:["v-footer",u.value,c.value,S.value,T.value,C.value,n.class],style:[R.value,n.app?o.value:{height:ce(n.height)},n.style]},e)),n.app?i:{}}}),Te={key:0,class:"py-1 pe-1"},Ae={class:"py-0 py-md-1",style:{"min-width":"30%"}},Ne=x("i",{class:"fa-solid fa-ellipsis fa-beat-fade fa-lg"},null,-1),Be={class:"small"},Pe={class:"d-flex justify-space-between px-4 align-baseline"},Oe={key:1},De={key:1,class:"py-1 ps-1"},B=L({__name:"chat-message",props:{skeleton:{type:Boolean},message:{},time:{},isMine:{type:Boolean},rating:{},comment:{},messageIndex:{}},setup(n){const _=n;if(isNaN(_.messageIndex))throw new Error("Message requires a numeric key");return(e,u)=>e.skeleton?(a(),l(j,{key:0},{default:d(()=>[e.isMine?(a(),l(E,{key:0,type:"avatar, paragraph",class:"flex-row-reverse"})):f("",!0),e.isMine?f("",!0):(a(),l(E,{key:1,type:"avatar, sentences"}))]),_:1})):(a(),m("div",{key:1,class:U(["d-flex",{"justify-end":e.isMine,"justify-start":!e.isMine}])},[e.isMine?(a(),m("div",Te,[y(D,{color:"primary"},{default:d(()=>[y(P,{icon:"mdi-account"})]),_:1})])):f("",!0),x("div",Ae,[y(de,{class:U(["mb-4",{"bg-primary-surface":e.isMine,"bg-secondary-surface":!e.isMine}])},{default:d(()=>[e.message==="…"&&!e.isMine?(a(),l(F,{key:0},{default:d(()=>[Ne]),_:1})):(a(),l(F,{key:1,class:"pa-2 px-4"},{default:d(()=>[V(le(e.message),1)]),_:1})),x("div",Be,[x("div",Pe,[e.isMine?(a(),m("span",Oe)):(a(),l(xe,{key:0,initialRating:e.rating,initialComment:e.comment,messageIndex:_.messageIndex},null,8,["initialRating","initialComment","messageIndex"])),e.time?(a(),l(v(we),{key:2,class:"text-grey small",time:new Date(e.time),locale:null},null,8,["time"])):f("",!0)])])]),_:1},8,["class"])]),e.isMine?f("",!0):(a(),m("div",De,[y(D,{color:"secondary"},{default:d(()=>[y(P,{icon:"mdi-robot"})]),_:1})]))],2))}}),Fe={key:0,class:"alert alert-primary",role:"alert"},Ue={key:0,class:"py-2 px-2 px-md-3"},$e={key:1,class:"py-2 px-2 px-md-3"},ze=L({__name:"chat-thread",props:{chatId:{},readOnly:{type:Boolean}},emits:["summaryNeedsUpdate"],setup(n,{emit:_}){const e=n,u=$(),c=ue({inputControl:null,typedMessage:"",pendingResponse:!1,invalidChatId:!1});N(()=>[u.currentAccount,e.chatId],async(o,i)=>{u.currentAccount&&(r.debug(r.context(),"chatId changed",o,i),await _e(u.currentAccount.id,e.chatId)&&t.chat?(u.chatId=e.chatId,t.chat.messages.length==0&&M(),await k(),C()):c.invalidChatId=!0)},{immediate:!0}),N(()=>e.readOnly,async(o,i)=>{r.debug(r.context(),"readonly changed =",o,i)},{immediate:!0});const R=me();N(()=>u.currentAccount,(o,i)=>{r.debug(r.context(),"currentAccount changed",o,i),u.currentAccount&&!u.isCurrentAccountMine()&&u.currentAccount.role=="admin"&&R.push({name:"chats"})},{immediate:!0});const S=_;let T=[{key:0,isMine:!1},{key:1,isMine:!0},{key:2,isMine:!1},{key:3,isMine:!0},{key:4,isMine:!1},{key:5,isMine:!0},{key:6,isMine:!1},{key:7,isMine:!0},{key:8,isMine:!1}];function C(){t.chat&&t.chat._id&&be(t.chat)&&(r.debug(r.context(),"emitting summary needs update, chatId = ",t.chat._id,"chat =",t.chat),S("summaryNeedsUpdate"),t.dirtyChatsMetadata.add(t.chat._id))}async function k(){await Ie(),window.scrollTo(0,document.body.scrollHeight)}async function M(o){var h;if(!t.chat)return;r.debug(r.context(),e.chatId,{userMessage:o});const i=$();if(!i.currentAccount){r.error(r.context(),"no current account");return}o&&(t.chat.messages.push({content:o,timestamp:new Date().toISOString(),type:"User",key:t.chat.messages.length}),c.typedMessage=""),c.pendingResponse=!0;let p={content:"…",timestamp:"",type:"AI",key:t.chat.messages.length};t.chat.messages.push(p),await k();const A=o?"/api/chat/{account_id}/{chat_id}":t.chat.messages.length>1?"/api/chat/{account_id}/{chat_id}/ping":"/api/chat/{account_id}/{chat_id}/initial",{data:s,error:g}=await Ce.POST(A,{params:{path:{account_id:i.currentAccount.id,chat_id:e.chatId}},body:{content:o??""}});g&&r.error(r.context(),g),c.pendingResponse=!1,s&&(t.chat.messages[p.key].timestamp=new Date(s.message.timestamp).toISOString(),t.chat.messages[p.key].content=s.message.content,t.chat={_id:t.chat._id,...s.metadata,messages:t.chat.messages}),await k(),(h=c.inputControl)==null||h.focus(),C()}async function b(){var o,i;if(r.debug(r.context(),"entering"),((o=c.inputControl)==null?void 0:o.value)===""){r.debug(r.context(),"sendMessage empty, ignoring.");return}M((i=c.inputControl)==null?void 0:i.value)}return(o,i)=>{const p=he("router-link"),A=ye("focus");return a(),m(w,null,[c.invalidChatId?(a(),m("div",Fe,[V(" This chat does not exist, maybe you should look in "),y(p,{to:"/chats"},{default:d(()=>[V("all chats")]),_:1}),V(". ")])):f("",!0),y(ge,null,{default:d(()=>[v(t).chat?(a(),m("div",Ue,[v(t).chat?(a(),l(pe,{key:0,name:"grow"},{default:d(()=>[(a(!0),m(w,null,z(v(t).chat.messages,s=>{var g,h;return a(),m(w,null,[s.type==="AI"?(a(),l(B,{message:s.content,time:s.timestamp,key:s.key,isMine:!1,messageIndex:s.key,rating:(g=s.rating)==null?void 0:g.rating,comment:((h=s.rating)==null?void 0:h.comment)??""},null,8,["message","time","messageIndex","rating","comment"])):(a(),l(B,{message:s.content,time:s.timestamp,key:-s.key,isMine:!0,messageIndex:s.key},null,8,["message","time","messageIndex"]))],64)}),256))]),_:1})):f("",!0)])):(a(),m("div",$e,[(a(!0),m(w,null,z(v(T),s=>(a(),l(B,{skeleton:"",key:s.key,isMine:s.isMine,messageIndex:s.key},null,8,["isMine","messageIndex"]))),128))]))]),_:1}),y(Se,{app:"",color:"surface-darken-1"},{default:d(()=>[y(j,{class:"v-col-sm-9 v-col-lg-6 pa-0"},{default:d(()=>{var s,g;return[fe((a(),l(Ve,{ref:h=>{c.inputControl=h},"hide-details":"",modelValue:c.typedMessage,"onUpdate:modelValue":i[0]||(i[0]=h=>c.typedMessage=h),density:"compact",variant:"outlined",placeholder:(s=v(t).chat)!=null&&s.closed?"Chat closed":e.readOnly?"":"Type message here",disabled:c.pendingResponse||e.readOnly||((g=v(t).chat)==null?void 0:g.closed),onClick:i[1]||(i[1]=h=>k()),onKeydown:ke(b,["enter"])},{"append-inner":d(()=>[c.typedMessage.length>0?(a(),l(P,{key:0,icon:"mdi-send-variant",color:"primary",onClick:b})):f("",!0)]),_:1},8,["modelValue","placeholder","disabled"])),[[A]]),ve(o.$slots,"footer-bottom",{},void 0,!0)]}),_:3})]),_:3})],64)}}}),Ge=Me(ze,[["__scopeId","data-v-d78e1c33"]]);export{Ge as C};
