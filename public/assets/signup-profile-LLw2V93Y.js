import{L as ee,a6 as te,a7 as oe,O as ae,a8 as le,P as ne,a9 as ie,aa as b,B as G,ab as re,S as q,W as ue,T as se,ac as de,e as t,F as me,X as L,J as ce,K as fe,ad as j,d as pe,$ as ve,l as d,r as ye,c as B,w as n,a as ge,b as I,ae as be,af as he,s as h,h as x,z as A,v as U,n as R,V as z,f as C,t as xe,g as _e,ag as Ve,ah as Te,a0 as W,ai as Ce,aj as ke}from"./main-B70GkIj-.js";import{r as F}from"./form-validation-CyjMhnzu.js";import{_ as Ee,a as Fe}from"./date-field.vue_vue_type_script_setup_true_lang-yjLF_jbp.js";import{V as Se,_ as X}from"./VForm-C5FypBKk.js";import{_ as Ne}from"./primary-button.vue_vue_type_script_setup_true_lang-1Pjcy-CF.js";import{V as J}from"./VContainer-DYD4C6sI.js";import{V as S}from"./VRow-CuQ7f1Ee.js";import{V as _}from"./VCol-BMSgih9K.js";import{m as De,a as Me,u as Pe,b as we,V as H}from"./VTextField-CfpYqE7h.js";/* empty css              */const Oe=ee({autofocus:Boolean,divider:String,focusAll:Boolean,label:{type:String,default:"$vuetify.input.otp"},length:{type:[Number,String],default:6},modelValue:{type:[Number,String],default:void 0},placeholder:String,type:{type:String,default:"number"},...te(),...De(),...oe(Me({variant:"outlined"}),["baseColor","bgColor","class","color","disabled","error","loading","rounded","style","theme","variant"])},"VOtpInput"),Be=ae()({name:"VOtpInput",props:Oe(),emits:{finish:a=>!0,"update:focused":a=>!0,"update:modelValue":a=>!0},setup(a,$){let{attrs:p,emit:e,slots:g}=$;const{dimensionStyles:Y}=le(a),{isFocused:k,focus:N,blur:D}=Pe(a),c=ne(a,"modelValue","",o=>o==null?[]:String(o).split(""),o=>o.join("")),{t:M}=ie(),V=b(()=>Number(a.length)),P=b(()=>Array(V.value).fill(0)),f=G(-1),T=G(),i=G([]),l=b(()=>i.value[f.value]);function r(){if(K(l.value.value)){l.value.value="";return}const o=c.value.slice(),s=l.value.value;o[f.value]=s;let v=null;f.value>c.value.length?v=c.value.length+1:f.value+1!==V.value&&(v="next"),c.value=o,v&&j(T.value,v)}function u(o){const s=c.value.slice(),v=f.value;let y=null;["ArrowLeft","ArrowRight","Backspace","Delete"].includes(o.key)&&(o.preventDefault(),o.key==="ArrowLeft"?y="prev":o.key==="ArrowRight"?y="next":["Backspace","Delete"].includes(o.key)&&(s[f.value]="",c.value=s,f.value>0&&o.key==="Backspace"?y="prev":requestAnimationFrame(()=>{var m;(m=i.value[v])==null||m.select()})),requestAnimationFrame(()=>{y!=null&&j(T.value,y)}))}function w(o,s){var y,m;s.preventDefault(),s.stopPropagation();const v=((y=s==null?void 0:s.clipboardData)==null?void 0:y.getData("Text").slice(0,V.value))??"";K(v)||(c.value=v.split(""),(m=i.value)==null||m[o].blur())}function O(){c.value=[]}function Q(o,s){N(),f.value=s}function Z(){D(),f.value=-1}function K(o){return a.type==="number"&&/[^0-9]/g.test(o)}return re({VField:{color:b(()=>a.color),bgColor:b(()=>a.color),baseColor:b(()=>a.baseColor),disabled:b(()=>a.disabled),error:b(()=>a.error),variant:b(()=>a.variant)}},{scoped:!0}),q(c,o=>{o.length===V.value&&e("finish",o.join(""))},{deep:!0}),q(f,o=>{o<0||ue(()=>{var s;(s=i.value[o])==null||s.select()})}),se(()=>{var v;const[o,s]=de(p);return t("div",L({class:["v-otp-input",{"v-otp-input--divided":!!a.divider},a.class],style:[a.style]},o),[t("div",{ref:T,class:"v-otp-input__content",style:[Y.value]},[P.value.map((y,m)=>t(me,null,[a.divider&&m!==0&&t("span",{class:"v-otp-input__divider"},[a.divider]),t(we,{focused:k.value&&a.focusAll||f.value===m,key:m},{...g,loader:void 0,default:()=>t("input",{ref:E=>i.value[m]=E,"aria-label":M(a.label,m+1),autofocus:m===0&&a.autofocus,autocomplete:"one-time-code",class:["v-otp-input__field"],disabled:a.disabled,inputmode:a.type==="number"?"numeric":"text",min:a.type==="number"?0:void 0,maxlength:"1",placeholder:a.placeholder,type:a.type==="number"?"text":a.type,value:c.value[m],onInput:r,onFocus:E=>Q(E,m),onBlur:Z,onKeydown:u,onPaste:E=>w(m,E)},null)})])),t("input",L({class:"v-otp-input-input",type:"hidden"},s,{value:c.value.join("")}),null),t(ce,{contained:!0,"content-class":"v-otp-input__loader","model-value":!!a.loading,persistent:!0},{default:()=>{var y;return[((y=g.loader)==null?void 0:y.call(g))??t(fe,{color:typeof a.loading=="boolean"?void 0:a.loading,indeterminate:!0,size:"24",width:"2"},null)]}}),(v=g.default)==null?void 0:v.call(g)])])}),{blur:()=>{var o;(o=i.value)==null||o.some(s=>s.blur())},focus:()=>{var o;(o=i.value)==null||o[0].focus()},reset:O,isFocused:k}}}),Ie=C("br",null,null,-1),Ae=C("br",null,null,-1),Ue={class:"text-grey my-3"},qe={class:"text-grey mt-3"},$e=15*60,He=pe({__name:"signup-profile",setup(a){var D,c,M,V,P,f,T;const $=ge(),p=ve();d.debug(d.context(),"person = ",p.person);const e=ye({movingToOtherStep:!1,formOk:!1,myAvatar:(D=p.person)==null?void 0:D.avatar,myGivenName:((c=p.person)==null?void 0:c.given_name)??"",myFamilyName:((M=p.person)==null?void 0:M.family_name)??"",myEmail:((V=p.person)==null?void 0:V.email)??"",myPhone:((P=p.person)==null?void 0:P.phone)??"",myBirthDate:(f=p.person)!=null&&f.birth_date?new Date((T=p.person)==null?void 0:T.birth_date):void 0,sentCodeCount:0,codeTimeout:void 0,codeTimeoutStep:1,codeTimeoutID:void 0,codeExpirationMsg:"",otp:"",otpErrorMsgs:{title:"",text:""},checkingOTP:!1,otpControl:null,formControl:null,continueControl:null,updateErrorMsgs:{title:"",text:""},resending:!1}),g=b(()=>e.myGivenName&&e.myFamilyName&&e.myEmail);q(()=>e.codeTimeout,async()=>{if(d.debug(d.context(),"codeTimeout changed to ",e.codeTimeout),e.codeTimeout!==void 0)if(e.codeTimeout<=0)d.debug(d.context(),"codeTimeout expired"),e.codeExpirationMsg="That code has expired.",e.codeTimeout=-1;else{if(e.codeTimeout>59){const i=Math.round(e.codeTimeout/60);e.codeExpirationMsg=`Your code will expire in ${i} minute${i>1?"s":""}.`,e.codeTimeoutStep=30}else e.codeExpirationMsg=`Your code will expire in ${e.codeTimeout} seconds.`,e.codeTimeoutStep=1;e.codeTimeoutID=setTimeout(()=>{e.codeTimeout&&(e.codeTimeout-=e.codeTimeoutStep)},e.codeTimeoutStep*1e3)}},{immediate:!0}),q(()=>e.otp,()=>{e.otp=e.otp.toUpperCase()});async function Y(){var i,l,r,u,w;d.debug(d.context(),"otp changed to ",e.otp);try{e.checkingOTP=!0,(i=e.otpControl)==null||i.blur();const{response:O}=await W.POST("/api/person/me/verify",{body:{email:e.myEmail,code:e.otp}});O.status==200||O.status==204?((l=e.formControl)==null||l.validate(),Ce(),e.codeTimeoutID&&(clearTimeout(e.codeTimeoutID),e.codeTimeoutID=void 0),(r=e.continueControl)==null||r.focus()):(e.otpErrorMsgs={title:"Invalid code",text:""},(u=e.otpControl)==null||u.reset(),(w=e.otpControl)==null||w.focus())}finally{e.checkingOTP=!1}}async function k(){e.movingToOtherStep=!0;try{const{error:i}=await W.PUT("/api/person/me",{body:{given_name:e.myGivenName||void 0,family_name:e.myFamilyName||void 0,birth_date:e.myBirthDate?e.myBirthDate.toISOString().substr(0,10):void 0,phone:e.myPhone||void 0}});i?(e.updateErrorMsgs={title:"Error",text:"Failed to update your profile"},d.error(d.context(),i)):(d.debug(d.context(),"going to verify"),$.push({name:"authorized"}))}catch(i){e.updateErrorMsgs={title:"Error",text:"Failed to update your profile"},d.error(d.context(),i)}finally{e.movingToOtherStep=!1}}async function N(){d.debug(d.context(),"resend");try{e.resending=!0,await ke()?(e.sentCodeCount++,e.codeTimeout=$e):e.otpErrorMsgs={title:"Error",text:"Failed to send email"}}finally{e.resending=!1}}return(i,l)=>(I(),B(J,{class:"v-col-sm-9 v-col-lg-6 v-col-xl-4 pa-0 mt-4"},{default:n(()=>[t(U,null,be({title:n(()=>[x("About you")]),subtitle:n(()=>[x(A(e.myEmail),1)]),default:n(()=>[t(Se,{ref:r=>{e.formControl=r},modelValue:e.formOk,"onUpdate:modelValue":l[10]||(l[10]=r=>e.formOk=r)},{default:n(()=>[t(J,null,{default:n(()=>[t(S,null,{default:n(()=>[t(_,null,{default:n(()=>[t(H,{type:"text",label:"Your first name",id:"myGivenName",modelValue:e.myGivenName,"onUpdate:modelValue":l[0]||(l[0]=r=>e.myGivenName=r),rules:[h(F).required,h(F).name],required:"",class:"required"},null,8,["modelValue","rules"])]),_:1}),t(_,null,{default:n(()=>[t(H,{type:"text",label:"Your last name",id:"myFamilyName",modelValue:e.myFamilyName,"onUpdate:modelValue":l[1]||(l[1]=r=>e.myFamilyName=r),rules:[h(F).required,h(F).name],required:"",class:"required"},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(S,{"no-gutters":""},{default:n(()=>[t(_,null,{default:n(()=>[t(Ee,{type:"tel",id:"myPhone",label:"Your phone number",modelValue:e.myPhone,"onUpdate:modelValue":l[2]||(l[2]=r=>e.myPhone=r),help:"Your phone number enables us to enhance our communication. We don't share your phone number with anyone.",rules:[h(F).phoneOrBlank]},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(S,{"no-gutters":""},{default:n(()=>[t(_,null,{default:n(()=>[t(Fe,{label:"Your birth date","min-date":-100*365,"max-date":0,id:"myBirthDate",help:"Your date of birth enables us to enhance our communication. We don't share your date of birth.",date:e.myBirthDate,"onUpdate:date":l[3]||(l[3]=r=>e.myBirthDate=r),required:"",class:"required"},null,8,["date"])]),_:1})]),_:1}),t(S,{"no-gutters":""},{default:n(()=>[t(_,null,{default:n(()=>{var r;return[((r=h(p).person)==null?void 0:r.validation)==="Verified"?(I(),B(U,{key:0,variant:"tonal"},{default:n(()=>[t(R,null,{default:n(()=>[t(X,{error:"",title:e.updateErrorMsgs.title,"onUpdate:title":l[4]||(l[4]=u=>e.updateErrorMsgs.title=u),msg:e.updateErrorMsgs.text,"onUpdate:msg":l[5]||(l[5]=u=>e.updateErrorMsgs.text=u),class:"mb-4"},null,8,["title","msg"]),t(S,null,{default:n(()=>[t(_,{cols:"auto",class:"align-self-center"},{default:n(()=>[t(z,{icon:"mdi-email-seal",size:"xx-large"})]),_:1}),t(_,{class:"text-left"},{default:n(()=>[C("span",null,A(e.myEmail)+" is confirmed",1),Ie]),_:1}),t(_,{cols:"auto",class:"align-self-center"},{default:n(()=>[t(Ne,{disabled:!e.formOk,ref:u=>{e.continueControl=u},onKeydown:xe(k,["enter"]),onClick:k,loading:e.movingToOtherStep},{default:n(()=>[x("Continue")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1})):e.sentCodeCount===0?(I(),B(U,{key:1,variant:"tonal",density:"compact"},{default:n(()=>[t(R,{class:"text-center"},{default:n(()=>[t(z,{icon:"mdi-alert-circle-outline",size:"large"}),x("   Your email is not confirmed yet     "),t(_e,{disabled:!g.value,class:"mt-4",elevation:"3",variant:"tonal",block:"",onClick:N,loading:e.resending},{default:n(()=>[x("Send email confirmation code")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})):(I(),B(U,{key:2,disabled:!g.value,variant:"tonal",density:"compact"},{default:n(()=>[t(R,{class:"text-center"},{default:n(()=>[t(z,{icon:"mdi-email",size:"large"}),x("   Check your email    "),Ae,C("div",Ue," Enter the 6-letter code we sent to "+A(e.myEmail)+". ",1),t(X,{error:"",title:e.otpErrorMsgs.title,"onUpdate:title":l[6]||(l[6]=u=>e.otpErrorMsgs.title=u),msg:e.otpErrorMsgs.text,"onUpdate:msg":l[7]||(l[7]=u=>e.otpErrorMsgs.text=u)},null,8,["title","msg"]),t(h(Be),{ref:u=>{e.otpControl=u},autofocus:"",class:"my-0",modelValue:e.otp,"onUpdate:modelValue":l[8]||(l[8]=u=>e.otp=u),onFinish:l[9]||(l[9]=u=>Y()),loading:e.checkingOTP,type:"text",placeholder:"-"},{loader:n(()=>[t(Ve,{indeterminate:""})]),_:1},8,["modelValue","loading"]),C("div",qe,[x(A(e.codeExpirationMsg)+" If you didn't receive it, please click ",1),C("a",{href:"#",onClick:Te(N,["prevent"])},"here"),x(" to send a new one. ")])]),_:1})]),_:1},8,["disabled"]))]}),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:2},[e.myAvatar?{name:"prepend",fn:n(()=>[t(he,{picture:e.myAvatar,firstName:e.myGivenName,lastName:e.myFamilyName,badge:h(p).invitationCount>0?h(p).invitationCount:void 0},null,8,["picture","firstName","lastName","badge"])]),key:"0"}:void 0]),1024)]),_:1}))}});export{He as default};
